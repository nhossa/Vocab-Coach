"""
StackTutor Database Migration Guide

This document explains how migrations work in StackTutor.
We use Alembic (SQLAlchemy migration tool) to manage schema versioning.

## Current Schema (Baseline)

Tables:
1. users
   - id (PK)
   - email (unique)
   - hashed_password
   - created_at

2. terms
   - id (PK)
   - term (unique)
   - category (old field, being phased out)
   - category_id (FK to categories.id)
   - formal_definition
   - simple_definition
   - example
   - why_it_matters
   - difficulty
   - created_at

3. categories
   - id (PK)
   - name (unique)
   - description

4. vocabulary_items
   - id (PK)
   - user_id (FK to users.id)
   - term_id (FK to terms.id)
   - review_count
   - saved_at
   - last_score

5. quiz_attempts
   - id (PK)
   - user_id (FK to users.id)
   - term_id (FK to terms.id)
   - user_answer
   - score
   - ai_feedback
   - correct_answer
   - attempted_at

## Running Migrations

### In Docker (Recommended for Production):
```bash
docker compose exec app alembic upgrade head
```

### Locally:
```bash
source venv/bin/activate
DATABASE_URL=postgresql://vocabuser:vocabpass@localhost:5432/vocabdb alembic upgrade head
```

## Creating a New Migration

After modifying `app/models.py`:

```bash
# Auto-generate migration
alembic revision --autogenerate -m "Add new column to users"

# Review the generated file in alembic/versions/
# Apply migration
alembic upgrade head
```

## Migration Best Practices

1. **Always review autogenerated migrations** — Alembic can miss some changes
2. **Test migrations on dev DB first** — Never run untested migrations in production
3. **Keep migrations small** — One logical change per migration
4. **Use descriptive names** — "add_email_unique_constraint" is better than "update_schema"
5. **Test rollback** — Verify `alembic downgrade -1` works safely

## Downgrading (Rolling Back)

```bash
# Rollback one migration
alembic downgrade -1

# Rollback to specific revision
alembic downgrade <revision_id>
```

## Checking Migration Status

```bash
# Show current schema version
alembic current

# Show all revisions
alembic history
```

## Notes for AWS Deployment

- Run migrations as part of ECS task before starting app
- Use CloudWatch to monitor migration logs
- Keep database backups before major migrations
- Consider blue-green deployments for zero-downtime migrations
"""
